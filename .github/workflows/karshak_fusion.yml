name: Karshak Fusion Build (Stable + Custom)
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    # We use the reliable 2023 container that matches the Stable V4.4 code
    container: mavlink/qgc-build-android:2023-10-10

    steps:
      # 1. Download the Reliable QGC Code (Stable V4.4)
      - name: Checkout Stable Code
        uses: actions/checkout@v3
        with:
          repository: mavlink/qgroundcontrol
          ref: Stable_V4.4
          submodules: recursive
          path: qgc-source

      # 2. Download YOUR Custom Logo & Settings (From your repo)
      - name: Checkout Your Custom Files
        uses: actions/checkout@v3
        with:
          path: my-custom-files

      # 3. The "Fusion" - Copy your files into the Stable Code
      - name: Inject Karshak Branding
        run: |
          echo "Injecting Custom Files..."
          # Copy the 'custom' folder from your repo into the QGC source
          cp -r my-custom-files/custom qgc-source/
          
          # Verify it worked
          ls -R qgc-source/custom

      # 4. Prepare the Build System
      - name: Create Build Directory
        run: mkdir build

      # 5. Configure (Using the classic qmake system that supports .pri files)
      - name: Configure
        working-directory: build
        # We point to qgc-source where we injected your files
        run: /opt/Qt/5.15.2/android/bin/qmake ../qgc-source -spec android-clang CONFIG+=installer

      # 6. Build the APK (This takes ~15-20 mins)
      - name: Compile APK
        working-directory: build
        run: make -j4 apk

      # 7. Save the Result
      - name: Upload Karshak APK
        uses: actions/upload-artifact@v4
        with:
          name: Karshak-Pilot-APK
          path: build/package/*.apk
