name: Karshak Stable Build (v4.4)
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    # This downloads a pre-made "Factory" with Qt 5.15 already installed
    container: mavlink/qgc-build-android:2023-10-10

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          submodules: recursive
          # CRITICAL: This forces us to use the Stable version, not the experimental one
          ref: Stable_V4.4

      - name: Apply Karshak Branding
        # We need to copy your custom folder into the fresh stable code
        run: |
          # Since we checked out Stable_V4.4, your 'custom' folder might be hidden in the 'master' branch.
          # We will pull your custom files from the master branch specifically.
          git fetch origin master
          git checkout origin/master -- custom/

      - name: Create Build Directory
        run: mkdir build

      - name: Configure (QMake)
        working-directory: build
        # This uses the stable 'qmake' system which is 100% reliable
        run: /opt/Qt/5.15.2/android/bin/qmake ../ -spec android-clang CONFIG+=installer

      - name: Compile APK
        working-directory: build
        run: make -j4 apk

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Karshak-Pilot-Stable
          path: build/package/*.apk
