name: Karshak Frozen Build (Time Machine)
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    # THE SECRET WEAPON: This is the exact factory image used in 2023.
    # It contains Qt 5.15.2, Java 11, and Android SDK pre-installed.
    container: mavlink/qgc-build-android:2023-10-10

    steps:
      # 1. Get the Stable Code (V4.4)
      - name: Checkout Stable Code
        uses: actions/checkout@v3
        with:
          repository: mavlink/qgroundcontrol
          ref: Stable_V4.4
          submodules: recursive
          path: qgc-source

      # 2. Get Your Custom Files
      - name: Checkout Your Custom Files
        uses: actions/checkout@v3
        with:
          path: my-custom-files

      # 3. Inject Branding (Copy-Paste)
      - name: Inject Karshak Branding
        run: |
          # Force copy your custom folder into the source code
          cp -r my-custom-files/custom qgc-source/
          
          # SAFETY: Fix "Git Safe Directory" error inside Docker
          git config --global --add safe.directory '*'

      # 4. Build (Using the Pre-Installed Tools)
      - name: Build APK
        working-directory: qgc-source
        run: |
          mkdir build
          cd build
          
          # We call the qmake that lives INSIDE the container
          /opt/Qt/5.15.2/android/bin/qmake ../ -spec android-clang CONFIG+=installer
          
          # Compile
          make -j4 apk

      # 5. Save Result
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Karshak-Pilot-APK
          path: qgc-source/build/package/*.apk
