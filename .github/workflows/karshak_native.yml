name: Karshak Final Build (Python Fix)
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      # 1. FIX: Setup Python FIRST to bypass the "Externally Managed" error
      - name: Setup Python (Fixes Exit Code 1)
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' 

      # 2. Add Virtual RAM (Prevent Crash)
      - name: Create Swap Space
        run: |
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      # 3. Get Code
      - name: Checkout Stable Code
        uses: actions/checkout@v3
        with:
          repository: mavlink/qgroundcontrol
          ref: Stable_V4.4
          submodules: recursive
          path: qgc-source

      - name: Checkout Your Custom Files
        uses: actions/checkout@v3
        with:
          path: my-custom-files

      - name: Inject Karshak Branding
        run: cp -r my-custom-files/custom qgc-source/

      # 4. Install Qt (Now safe because Python is fixed)
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.15.2'
          host: 'linux'
          target: 'android'
          arch: 'android_arm64_v8a'
          dir: '${{ github.workspace }}/qt/'
          install-deps: 'true'
          modules: 'qtcharts'

      - name: Setup Java 11
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Setup Android NDK
        uses: android-actions/setup-android@v3
      - run: sdkmanager --install "ndk;21.3.6528147"

      # 5. Build
      - name: Configure
        working-directory: qgc-source
        run: |
          mkdir build
          cd build
          ${{ github.workspace }}/qt/Qt_5.15.2/android/bin/qmake ../ -spec android-clang CONFIG+=installer

      - name: Compile APK
        working-directory: qgc-source/build
        run: make -j2 apk

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Karshak-Pilot-APK
          path: qgc-source/build/package/*.apk
