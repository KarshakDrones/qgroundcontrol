name: Karshak Native Build (Qt 5.15)
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-20.04  # Older Ubuntu is more stable for Qt 5.15
    
    steps:
      # 1. Download the Reliable QGC Code (Stable V4.4)
      - name: Checkout Stable Code
        uses: actions/checkout@v3
        with:
          repository: mavlink/qgroundcontrol
          ref: Stable_V4.4
          submodules: recursive
          path: qgc-source

      # 2. Download YOUR Custom Logo & Settings
      - name: Checkout Your Custom Files
        uses: actions/checkout@v3
        with:
          path: my-custom-files

      # 3. Inject Your Branding
      - name: Inject Karshak Branding
        run: |
          echo "Injecting Custom Files..."
          cp -r my-custom-files/custom qgc-source/
          ls -R qgc-source/custom

      # 4. Install Qt 5.15.2 (The Engine)
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.15.2'
          host: 'linux'
          target: 'android'
          arch: 'android_arm64_v8a'
          dir: '${{ github.workspace }}/qt/'
          install-deps: 'true'
          modules: 'qtcharts'
          archives: 'qtbase qtdeclarative qtimageformats qtmultimedia qtquickcontrols qtquickcontrols2 qtserialport qtsvg qtwebsockets qtcharts'

      # 5. Install Java 11 (Required for Android)
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'

      # 6. Setup Android SDK/NDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Install NDK
        run: sdkmanager --install "ndk;21.3.6528147"

      # 7. Configure (QMake)
      - name: Configure
        working-directory: qgc-source
        run: |
          mkdir build
          cd build
          # Use the Qt we just installed
          ${{ github.workspace }}/qt/Qt_5.15.2/android/bin/qmake ../ -spec android-clang CONFIG+=installer

      # 8. Build the APK
      - name: Compile APK
        working-directory: qgc-source/build
        run: make -j4 apk

      # 9. Upload Result
      - name: Upload Karshak APK
        uses: actions/upload-artifact@v4
        with:
          name: Karshak-Pilot-APK
          path: qgc-source/build/package/*.apk
